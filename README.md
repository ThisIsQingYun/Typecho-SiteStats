# SiteStats - Typecho 网站统计插件

一个轻量级的 Typecho 网站统计插件，用于统计和显示网站访问数据。
** 我的博客： ** [氢云小屋](https://www.uomn.cn)

## 功能特性

- **访问人数统计**：按 IP 地址统计独立访客数量
- **浏览量统计**：可配置防刷间隔，防止恶意刷新（默认5分钟）
- **访问次数统计**：记录用户当天的访问次数，支持会话管理
- **在线用户统计**：可配置在线用户超时时间（默认1分钟）
- **实时更新**：可配置的自动更新间隔（默认3秒）
- **时间控制**：灵活的时间间隔配置，包括防刷、会话和在线检测
- **自定义模板**：支持变量替换的自定义显示模板
- **自定义样式**：完全可定制的CSS样式
- **响应式设计**：适配移动端和桌面端
- **动画效果**：可配置的数据更新动画（慢速/正常/快速/无动画）
- **PJAX兼容**：完全兼容 PJAX 页面切换
- **深色主题支持**：自动适配深色主题
- **数据安全**：使用文件存储，数据目录受保护

## 安装方法

1. 将整个 `SiteStats` 文件夹上传到 Typecho 的 `usr/plugins/` 目录
2. 在 Typecho 后台的「控制台」->「插件管理」中激活插件
3. 根据需要调整插件设置

## 使用方法

### 在侧边栏显示

在主题的 `sidebar.php` 文件中添加以下代码：

```php
<?php if (class_exists('SiteStats_Plugin')): ?>
<section class="widget">
    <h3 class="widget-title">网站统计</h3>
    <?php SiteStats_Plugin::render(); ?>
</section>
<?php endif; ?>
```

### 在页脚显示

在主题的 `footer.php` 文件中添加以下代码：

```php
<?php if (class_exists('SiteStats_Plugin')): ?>
<div class="site-stats-footer">
    <?php SiteStats_Plugin::render(); ?>
</div>
<?php endif; ?>
```

### 在任意位置显示

在任何模板文件中都可以使用以下代码显示统计信息：

```php
<?php 
if (class_exists('SiteStats_Plugin')) {
    SiteStats_Plugin::render();
}
?>
```

## 插件配置

在插件设置页面可以配置以下选项：

### 基础设置
- **数据更新间隔**：前端统计数据自动更新的间隔时间（毫秒，默认3000）
- **动画速度**：数字更新动画效果（慢速/正常/快速/无动画）

### 时间控制设置
- **防刷间隔**：同一IP重复访问的防刷时间（秒，默认300）
  - 防止恶意刷新页面导致浏览量统计异常
  - 建议设置为300秒（5分钟）
- **会话间隔**：用户会话超时时间（秒，默认1800）
  - 超过此时间的访问将被视为新会话
  - 影响今日访问次数的统计
  - 建议设置为1800秒（30分钟）
- **在线用户超时**：在线用户检测超时时间（秒，默认60）
  - 用户无活动超过此时间将不再被视为在线
  - 建议设置为60秒（1分钟）

### 显示设置
- **自定义数据展示模板**：支持使用变量自定义显示内容
  - 可用变量：`{visitors}`（总访客数）、`{views}`（总浏览量）、`{today}`（今日访问）、`{online}`（在线用户）
  - 数字元素需包含 `data-type` 和 `data-count` 属性以支持动态更新
  - 示例模板：
    ```html
    <div class="stats-item">
        <span>访客数：</span>
        <span class="stats-value" data-type="visitors" data-count="0">{visitors}</span>
    </div>
    ```
- **自定义CSS样式**：完全自定义统计组件的外观样式

## 文件结构

```
SiteStats/
├── Plugin.php          # 插件主文件
├── api.php             # API接口文件
├── README.md           # 说明文档
├── assets/             # 静态资源
│   ├── stats.css       # 样式文件
│   └── stats.js        # JavaScript文件
└── data/               # 数据存储目录（自动创建）
    ├── .htaccess       # 访问保护文件
    ├── stats.json      # 统计数据
    ├── visits.json     # 访问记录
    └── online.json     # 在线用户
```

## 数据说明

### 统计逻辑

- **访客数**：按 IP 地址统计，每个 IP 只计算一次
- **浏览量**：同一 IP 地址在防刷间隔内只计算一次浏览量（可配置，默认5分钟）
- **访问次数**：用户当天的访问次数，新会话或超过会话间隔才增加（可配置，默认30分钟）
- **在线用户**：在线用户超时时间内有活动的用户数量（可配置，默认1分钟）

### 时间间隔配置

所有时间间隔都可以在插件设置中自定义：
- **防刷间隔**：防止短时间内重复计算浏览量
- **会话间隔**：区分用户的不同访问会话
- **在线用户超时**：判断用户是否仍在线的时间阈值
- **数据更新间隔**：前端自动刷新统计数据的频率

### 数据存储

插件使用 JSON 文件存储数据，所有数据文件都存储在 `data/` 目录中，并通过 `.htaccess` 文件保护，防止直接访问。

## PJAX 兼容性

插件完全兼容 PJAX 页面切换，支持以下事件：

- `pjax:start` / `pjax:end`
- `turbo:load`
- `swup:contentReplaced`

在 PJAX 页面切换时，插件会自动清理旧的事件监听器并重新初始化。

## 自定义样式

如果需要自定义样式，可以在主题的 CSS 文件中覆盖以下类：

```css
/* 主容器 */
.site-stats {
    /* 自定义样式 */
}

/* 统计数据容器 */
.site-stats-content {
    /* 自定义样式 */
}

/* 统计项目 */
.stats-item {
    /* 自定义样式 */
}

/* 数值样式 */
.stats-value {
    /* 自定义样式 */
}
```

## 性能优化

- 使用文件锁防止并发写入冲突
- 智能缓存访客数据，避免重复计算
- 定期清理过期的在线用户数据
- 使用 JSON 格式存储，读写效率高
- 前端使用防抖和节流技术，减少不必要的请求

## 安全特性

- 数据目录通过 `.htaccess` 保护
- API 接口验证请求来源
- 使用文件锁防止数据竞争
- 输入数据验证和过滤
- 错误处理和异常捕获

## 故障排除

### 统计数据不显示

1. 检查插件是否已激活
2. 确认模板中已添加渲染代码
3. 检查 `data/` 目录是否可写
4. 查看浏览器控制台是否有 JavaScript 错误

### 数据不更新

1. 检查网络连接
2. 确认 API 接口可访问
3. 查看服务器错误日志
4. 检查文件权限设置

### PJAX 兼容问题

1. 确认 PJAX 库版本兼容
2. 检查事件监听器是否正确绑定
3. 查看浏览器控制台错误信息

## 版本历史

### v1.1.0
- 新增可配置的时间间隔设置
  - 防刷间隔配置（防止恶意刷新）
  - 会话间隔配置（会话管理）
  - 在线用户超时配置（在线检测）
- 新增自定义数据展示模板功能
  - 支持变量替换（{visitors}、{views}、{today}、{online}）
  - 灵活的HTML模板定制
- 新增自定义CSS样式功能
- 改进的动画配置（支持无动画选项）
- 优化API配置加载机制
- 增强的向后兼容性

### v1.0.0
- 初始版本发布
- 基础统计功能
- PJAX 兼容支持
- 响应式设计
- 深色主题适配

## 技术支持

如果在使用过程中遇到问题，请检查：

1. Typecho 版本兼容性
2. PHP 版本要求（推荐 PHP 7.0+）
3. 文件权限设置
4. 服务器配置

## 许可证

本插件遵循 MIT 许可证开源。

## 更新日志

详细的更新日志请查看项目的 Git 提交记录。